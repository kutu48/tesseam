<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SEAM SEALING INSPECTION</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    thead tr:first-child {
      background-color: #007bff;
      color: white;
    }
    .filter-container {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    label {
      font-weight: bold;
    }
    tfoot tr {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    tfoot td.highlight {
      background-color: #ffcccc !important;
      color: #b30000;
    }
    @media screen and (max-width: 768px) {
      .filter-container {
        flex-direction: column;
        align-items: flex-start;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <h2>SEAM SEALING INSPECTION</h2>

  <div class="filter-container">
    <label for="startDate">Start Date:</label>
    <input type="datetime-local" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="datetime-local" id="endDate">
    <button id="filterDate">Filter</button>
    <button id="resetFilter">Reset</button>
    <button id="exportExcel">Export ke Excel</button>
  </div>

  <table id="inspectionTable" class="display nowrap">
    <thead>
      <tr id="table-header"></tr>
      <tr id="filter-row"></tr> <!-- Filter dropdown row -->
    </thead>
    <tbody id="table-body"></tbody>
    <tfoot>
      <tr id="table-footer"></tr>
      <tr id="table-footer-percent"></tr>
    </tfoot>
  </table>

  <!-- LIBRARY -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const sheetURL = "https://opensheet.elk.sh/1sBuZkxrxZqPD88mVHFm1-PXvXuEJZoAMaN2bgand1Wc/Form%20Responses%201";
    let rawData = [];
    let table;
    const sumColumns = [
      "TOTAL CEK", "Sealing tidak center", "Sealing tidak nempel",
      "seam allowance tidak searah", "potongan tidak rapih", "Sisa benang di sealing"
    ];
    const defectColumns = sumColumns.slice(1);

    function parseDate(str) {
      const [month, day, yearAndTime] = str.split('/');
      const [year, time = "00:00:00"] = yearAndTime.split(' ');
      const [hour = "00", minute = "00", second = "00"] = time.split(':');
      const cleanHour = parseInt(hour).toString(); // Hapus leading zero
      return new Date(`${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${cleanHour.padStart(2, '0')}:${minute || '00'}:${second || '00'}`);
    }

    function filterByDate(data, start, end) {
      return data.filter(row => {
        const date = parseDate(row["Timestamp"]);
        return (!start || date >= start) && (!end || date <= end);
      });
    }

    function renderTable(data) {
      if (table) {
        table.destroy();
        $('#inspectionTable tbody').empty();
        $('#inspectionTable thead tr#table-header').empty();
        $('#inspectionTable thead tr#filter-row').empty();
        $('#inspectionTable tfoot tr').empty();
      }

      const headers = Object.keys(data[0]);
      const headerRow = document.getElementById("table-header");
      const filterRow = document.getElementById("filter-row");
      headers.forEach(key => {
        const th = document.createElement("th");
        th.textContent = key;
        headerRow.appendChild(th);

        const td = document.createElement("td");
        const select = document.createElement("select");
        select.innerHTML = `<option value="">All</option>`;
        select.setAttribute("data-column", key);
        td.appendChild(select);
        filterRow.appendChild(td);
      });

      const tbody = document.getElementById("table-body");
      data.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach(key => {
          const td = document.createElement("td");
          td.textContent = row[key];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      const tfoot = document.getElementById("table-footer");
      const tfootPercent = document.getElementById("table-footer-percent");

      function updateFooter(filteredData) {
        const totals = {};
        headers.forEach(key => totals[key] = 0);

        filteredData.forEach(row => {
          headers.forEach(key => {
            if (sumColumns.includes(key)) {
              totals[key] += parseInt(row[key]) || 0;
            }
          });
        });

        const totalRow = headers.map(key => sumColumns.includes(key) ? `<td>${totals[key]}</td>` : "<td></td>");
        const percentRow = headers.map(key => {
          if (defectColumns.includes(key)) {
            const totalCek = totals["TOTAL CEK"];
            const percent = totalCek > 0 ? ((totals[key] / totalCek) * 100).toFixed(1) : "0";
            const isHigh = parseFloat(percent) > 5;
            return `<td class="${isHigh ? 'highlight' : ''}">${percent}%</td>`;
          } else if (key === "TOTAL CEK") {
            return `<td>100%</td>`;
          } else {
            return "<td></td>";
          }
        });

        tfoot.innerHTML = totalRow.join("");
        tfootPercent.innerHTML = percentRow.join("");
      }

      table = $('#inspectionTable').DataTable({
        scrollX: true,
        pageLength: 10
      });

      // Isi select options & aktifkan filter
      headers.forEach((key, i) => {
        const column = table.column(i);
        const select = filterRow.querySelector(`select[data-column="${key}"]`);
        column.data().unique().sort().each(function (d) {
          if (d) {
            const option = document.createElement("option");
            option.value = d;
            option.textContent = d;
            select.appendChild(option);
          }
        });

        $(select).on('change', function () {
          const val = $.fn.dataTable.util.escapeRegex($(this).val());
          column.search(val ? '^' + val + '$' : '', true, false).draw();
        });
      });

      table.on('draw', function () {
        const filteredData = table.rows({ filter: 'applied' }).data().toArray().map(row => {
          const obj = {};
          headers.forEach((key, i) => {
            obj[key] = row[i];
          });
          return obj;
        });
        updateFooter(filteredData);
      });

      table.draw();
    }

    function exportToExcel() {
      if (!table) return;
      const headers = [];
      $('#inspectionTable thead tr#table-header th').each(function () {
        headers.push($(this).text());
      });

      const filteredData = table.rows({ filter: 'applied' }).data().toArray();
      const data = filteredData.map(row => {
        const obj = {};
        headers.forEach((key, i) => {
          obj[key] = row[i];
        });
        return obj;
      });

      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Inspeksi");

      XLSX.writeFile(workbook, "Data-Inspeksi-QC.xlsx");
    }

    document.getElementById("filterDate").addEventListener("click", () => {
      const start = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
      const end = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;
      const filtered = filterByDate(rawData, start, end);
      renderTable(filtered);
    });

    document.getElementById("resetFilter").addEventListener("click", () => {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      renderTable(rawData);
    });

    document.getElementById("exportExcel").addEventListener("click", exportToExcel);

    function loadData() {
      fetch(sheetURL)
        .then(res => res.json())
        .then(data => {
          rawData = data;
          renderTable(data);
        })
        .catch(err => console.error("Gagal mengambil data:", err));
    }

    loadData();
  </script>
</body>
</html>
